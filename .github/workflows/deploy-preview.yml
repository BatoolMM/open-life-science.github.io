name: Deploy Preview for Pull Requests

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:   # Allow manual trigger of workflow from "Actions" tab

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1
        bundler-cache: true

    - name: Install dependencies
      run: |
        bundle install

    - name: Build Jekyll site
      run: |
        bundle exec jekyll build --destination _site

    - name: Clone existing gh-pages branch
      run: | # Preserves previously deployed PR previews
        git config --global user.name 'github-actions'
        git config --global user.email 'github-actions@github.com'
        git clone --depth 1 --branch gh-pages https://x-access-token:${{ secrets.PR_PREVIEW_TOKEN }}@github.com/open-life-science/ols-site-preview.git gh-pages
      env:
        GIT_TERMINAL_PROMPT: 0

    - name: Copy built site into PR folder
      run: |
        pr_number=${{ github.event.pull_request.number }}
        mkdir -p gh-pages/$pr_number
        rm -rf gh-pages/$pr_number/*
        cp -r _site/* gh-pages/$pr_number/

    - name: Push updated preview site
      run: |
        cd gh-pages
        git add .
        git commit -m "Deploy preview for PR #${{ github.event.pull_request.number }}"
        git push origin gh-pages

    - name: Comment with preview URL
      env:
        GITHUB_TOKEN: ${{ secrets.PR_PREVIEW_TOKEN }}
      run: |
        PREVIEW_URL="https://we-are-ols.org/ols-site-preview/${{ github.event.pull_request.number }}/"
        COMMENT_BODY="ðŸŽ‰ A preview of this PR is available at: [${PREVIEW_URL}](${PREVIEW_URL})"
        gh pr comment ${{ github.event.pull_request.number }} --body "$COMMENT_BODY"
